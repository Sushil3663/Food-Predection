<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Food Price Predictor - Nepal</title>
    <!-- Google Fonts: Inter -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6; /* Light gray background */
      }
      /* Custom styles for subtle shadow on button and loading state */
      button:hover {
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      .loading {
        opacity: 0.6;
        pointer-events: none; /* Disables interaction with form while loading */
      }
    </style>
  </head>
  <body class="min-h-screen flex items-center justify-center p-4">
    <div
      class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md border border-gray-200"
    >
      <h1 class="text-4xl font-extrabold text-blue-800 mb-6 text-center">
        Food Price Forecast
      </h1>
      <p class="text-center text-gray-600 mb-8">
        Predict future food prices in Nepal's markets.
      </p>

      <form id="prediction-form" class="space-y-5">
        <div>
          <label
            for="commodity"
            class="block text-sm font-semibold text-gray-700 mb-1"
            >Select Commodity:</label
          >
          <select
            id="commodity"
            name="commodity"
            required
            class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-base transition duration-150 ease-in-out bg-gray-50 hover:bg-gray-100"
          >
            <!-- Options will be dynamically loaded by Flask -->
            {% for comm in commodities %}
            <option value="{{ comm }}">{{ comm }}</option>
            {% endfor %}
            <!-- Fallback options if Flask doesn't provide them initially (e.g., if df_original_data loading fails) -->
            {% if not commodities %}
            <option value="Rice (coarse)">Rice (coarse)</option>
            <option value="Wheat flour">Wheat flour</option>
            <option value="Potatoes (red)">Potatoes (red)</option>
            <option value="Meat (chicken)">Meat (chicken)</option>
            <option value="Tomatoes">Tomatoes</option>
            <option value="Oil (vegetable)">Oil (vegetable)</option>
            <option value="Salt">Salt</option>
            <option value="Lentils (broken)">Lentils (broken)</option>
            <option value="Sugar">Sugar</option>
            {% endif %}
          </select>
        </div>

        <div>
          <label
            for="market"
            class="block text-sm font-semibold text-gray-700 mb-1"
            >Select Market:</label
          >
          <select
            id="market"
            name="market"
            required
            class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-base transition duration-150 ease-in-out bg-gray-50 hover:bg-gray-100"
          >
            <!-- Options will be dynamically loaded by Flask -->
            {% for mkt in markets %}
            <option value="{{ mkt }}">{{ mkt }}</option>
            {% endfor %}
            <!-- Fallback options if Flask doesn't provide them initially -->
            {% if not markets %}
            <option value="Kathmandu">Kathmandu</option>
            <option value="Jumla">Jumla</option>
            <option value="Birendranagar">Birendranagar</option>
            <option value="Dhangadhi">Dhangadhi</option>
            <option value="Pokhara">Pokhara</option>
            <option value="Biratnagar">Biratnagar</option>
            <option value="Butwal">Butwal</option>
            {% endif %}
          </select>
        </div>

        <div>
          <label
            for="months_ahead"
            class="block text-sm font-semibold text-gray-700 mb-1"
            >Predict Months Ahead:</label
          >
          <input
            type="number"
            id="months_ahead"
            name="months_ahead"
            value="1"
            min="1"
            max="24"
            required
            class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-base transition duration-150 ease-in-out bg-gray-50 hover:bg-gray-100"
          />
        </div>

        <button
          type="submit"
          id="predict-button"
          class="w-full py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-bold text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200 ease-in-out"
        >
          Get Prediction
        </button>
      </form>

      <div
        id="prediction-result"
        class="mt-8 p-5 bg-blue-100 rounded-lg text-blue-900 text-center text-xl font-bold hidden border border-blue-200"
      >
        <!-- Prediction results will be displayed here -->
      </div>
      <div
        id="error-message"
        class="mt-8 p-5 bg-red-100 rounded-lg text-red-800 text-center text-base font-semibold hidden border border-red-200"
      >
        <!-- Error messages will be displayed here -->
      </div>
      <div
        id="loading-message"
        class="mt-8 p-5 bg-yellow-100 rounded-lg text-yellow-800 text-center text-base font-semibold hidden border border-yellow-200"
      >
        Making prediction...
      </div>
    </div>

    <script>
      document
        .getElementById("prediction-form")
        .addEventListener("submit", async function (event) {
          event.preventDefault(); // Prevent default form submission

          const commodity = document.getElementById("commodity").value;
          const market = document.getElementById("market").value;
          const monthsAheadValue =
            document.getElementById("months_ahead").value; // Get raw string value first
          const monthsAhead = parseInt(monthsAheadValue); // Then parse it

          const resultDiv = document.getElementById("prediction-result");
          const errorDiv = document.getElementById("error-message");
          const loadingDiv = document.getElementById("loading-message");
          const predictButton = document.getElementById("predict-button");
          const form = document.getElementById("prediction-form");

          // Clear previous messages and show loading
          resultDiv.classList.add("hidden");
          errorDiv.classList.add("hidden");
          loadingDiv.classList.remove("hidden");
          predictButton.textContent = "Processing...";
          form.classList.add("loading"); // Add loading class to form to dim and disable inputs

          // --- Debugging console logs ---
          console.log("Raw monthsAhead input value:", monthsAheadValue);
          console.log("Parsed monthsAhead (integer):", monthsAhead);
          console.log("Type of parsed monthsAhead:", typeof monthsAhead);
          // --- End debugging console logs ---

          console.log("Sending request with data:", {
            commodity,
            market,
            months_ahead: monthsAhead,
          });

          try {
            const response = await fetch("http://127.0.0.1:5000/predict", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                commodity,
                market,
                months_ahead: monthsAhead,
              }), // Explicitly map variable to key
            });

            console.log("Response status:", response.status);

            // Check for HTTP errors (e.g., 404, 500, 405)
            if (!response.ok) {
              const errorBody = await response.json().catch(() => ({})); // Try to parse JSON error, fallback to empty object
              // Provide more detailed error if available
              throw new Error(
                `HTTP error! Status: ${response.status}. Message: ${
                  errorBody.error ||
                  response.statusText ||
                  "No specific error message from server."
                }`
              );
            }

            const data = await response.json();
            console.log("Response data:", data);

            if (data.error) {
              errorDiv.textContent = `Error: ${data.error}`;
              errorDiv.classList.remove("hidden");
            } else {
              resultDiv.innerHTML = `
                        <div class="text-lg font-bold mb-2">Prediction Results</div>
                        <div class="text-base">
                            <strong>Commodity:</strong> ${data.commodity}<br>
                            <strong>Market:</strong> ${data.market}<br>
                            <strong>Prediction Date:</strong> ${data.prediction_date}<br>
                            <strong>Predicted Price:</strong> ${data.predicted_price}
                        </div>
                    `;
              resultDiv.classList.remove("hidden");
            }
          } catch (error) {
            console.error("Fetch error:", error);
            errorDiv.textContent = `Network error: ${error.message}. Please check if the server is running on http://127.0.0.1:5000 and inspect browser console/network tab for more details.`;
            errorDiv.classList.remove("hidden");
          } finally {
            // Hide loading and restore button
            loadingDiv.classList.add("hidden");
            predictButton.textContent = "Get Prediction";
            form.classList.remove("loading");
          }
        });
    </script>
  </body>
</html>
